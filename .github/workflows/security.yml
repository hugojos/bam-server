name: PR Security (CodeQL + Gitleaks + Trivy)

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read
  security-events: write   # para subir SARIF de CodeQL

jobs:
  codeql:
    name: CodeQL (JavaScript/TypeScript)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  gitleaks:
    name: Secret scanning (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy-fs:
    name: Vulnerabilities (Trivy - filesystem)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          format: table
          ignore-unfixed: true
          severity: CRITICAL,HIGH

  trivy-image:
    name: Vulnerabilities (Trivy - image)
    runs-on: ubuntu-latest
    needs: trivy-fs
    if: ${{ hashFiles('**/Dockerfile') != '' }}  # solo si hay Dockerfile
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build local image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: local/security:test
      - name: Scan built image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: local/security:test
          format: table
          ignore-unfixed: true
          severity: CRITICAL,HIGH
